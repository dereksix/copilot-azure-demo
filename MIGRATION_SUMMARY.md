# Azure Developer CLI (azd) Migration Summary

## ‚úÖ Implementation Complete

The deployment mechanism has been successfully migrated from the legacy PowerShell script (`deploy.ps1`) to **Azure Developer CLI (azd)** with **Bicep Infrastructure-as-Code**.

### Branch
- **Branch Name**: `feat/azd-migration`
- **Commit**: `e4edc829be94aa06a3bfc53d329281f6999452f9`
- **Files Changed**: 8 files, +601 insertions

---

## üìÅ Files Created

### Infrastructure as Code (IaC)
- **`azd.yaml`** ‚Äî Project manifest defining services (frontend/backend), provisioning step, and outputs
- **`infra/main.bicep`** ‚Äî Main Bicep template with all Azure resources and deterministic naming
- **`infra/modules/webapp.bicep`** ‚Äî Reusable module for App Service creation with logging
- **`infra/modules/sql.bicep`** ‚Äî SQL Server/DB module with Managed Identity and Azure AD auth
- **`infra/parameters.json`** ‚Äî Default parameters for local development

### Supporting Scripts & Docs
- **`scripts/azd-post-provision.ps1`** ‚Äî Post-provision hook that generates `env-config.txt` from azd outputs
- **`README.md`** ‚Äî Updated with azd workflow documentation
- **`.github/copilot-instructions.md`** ‚Äî Updated with new IaC approach and Managed Identity details

---

## üîë Key Features

### ‚ú® Naming Strategy
- **Deterministic**: Uses `uniqueString(resourceGroup().id, environment)` for predictable names
- **Optionally Overridable**: Pass `--parameter suffix=<value>` to `azd provision` for isolated CI/demo runs
- **Example**: `app-backend-demo-7a1f`, `sql-demo-7a1f`, `stdemo7a1f`

### üîê Security (Managed Identity)
- **No Passwords**: Web Apps use User-Assigned Managed Identity for SQL authentication
- **Azure AD Only**: SQL Server configured with Entra ID authentication (no SQL password)
- **RBAC-Ready**: Managed Identity outputs (`managedIdentityPrincipalId`, `managedIdentityClientId`)

### üì¶ Backwards Compatibility
- **`env-config.txt`** auto-generated by `azd-post-provision.ps1`
- Existing `simulate-issues.ps1` and `generate-load.ps1` scripts continue to work unchanged
- Legacy `deploy.ps1` still available (deprecated, but supported)

### üöÄ Deployment Workflow
```powershell
# Step 1: Get SQL admin Entra ID info
$adminUpn = "your-admin@yourtenant.onmicrosoft.com"
$adminObjectId = az ad user show --id $adminUpn --query id -o tsv

# Step 2: Provision infrastructure
azd provision --parameter sqlAdminPrincipalId=$adminObjectId --parameter sqlAdminLogin=$adminUpn

# Step 3: (Optional) Deploy application code
azd deploy

# Step 4: Generate demo issues and load
.\simulate-issues.ps1 -Issue all-issues
.\generate-load.ps1 -Scenario all
```

---

## üìã Resource Inventory

| Resource | Module | Type | Notes |
|----------|--------|------|-------|
| Resource Group | main.bicep | Managed by azd | Scoped container |
| Managed Identity | main.bicep | User-Assigned | Shared by Web Apps |
| Storage Account | main.bicep | Standard LRS | Logs, diagnostics |
| Application Insights | main.bicep | Web | Full-stack tracing |
| App Service Plan | main.bicep | B1 Linux | Hosts both web apps |
| Frontend Web App | webapp.bicep | Node.js 18 | UI + API_URL |
| Backend Web App | webapp.bicep | Node.js 18 | REST API + SQL connection |
| SQL Server | sql.bicep | Azure AD auth | Managed Identity + Entra ID |
| SQL Database | sql.bicep | Basic (5 DTU) | appdb (2 GB max) |
| Firewall Rules | sql.bicep | AllowAzureServices | App Service connectivity |

---

## üîÑ Bicep Output Mapping

Bicep outputs are automatically mapped to azd environment variables by `azd.yaml`:

| Bicep Output | Environment Variable | Usage |
|--------------|----------------------|-------|
| `frontendUrl` | `FRONTEND_URL` | Frontend app endpoint |
| `backendUrl` | `BACKEND_URL` | Backend API endpoint |
| `appInsightsInstrumentationKey` | `APP_INSIGHTS_KEY` | Application Insights instrumentation |
| `sqlServerFqdn` | `SQL_SERVER_FQDN` | SQL Server hostname |
| `storageAccountName` | `STORAGE_ACCOUNT_NAME` | Storage for logs/diagnostics |
| `managedIdentityClientId` | (env-config.txt) | App authentication |
| `managedIdentityPrincipalId` | (env-config.txt) | RBAC assignments |

---

## üß™ Next Steps

### Local Testing
1. **Authenticate**: `az login` and set your default subscription
2. **Provision**: Run `azd provision` with SQL admin credentials
3. **Verify**: Check Azure Portal for resources; review outputs
4. **Generate Load**: Run `.\simulate-issues.ps1 -Issue all-issues`
5. **Test Scripts**: Run `.\generate-load.ps1 -Scenario all` and verify App Insights data
6. **Cleanup**: Run `azd down` to remove resources

### CI/CD Integration (Optional)
- Update GitHub Actions workflow to use `azd provision` instead of `.\deploy.ps1`
- Pass `--parameter suffix=${{ github.run_number }}` for isolated CI runs
- Store SQL admin credentials in GitHub Secrets or use workload identity

### Documentation
- See [README.md](README.md) for user-facing deployment instructions
- See [.github/copilot-instructions.md](.github/copilot-instructions.md) for agent/developer guidelines

---

## üìå Breaking Changes

- **SQL Passwords**: No longer stored in code; uses Managed Identity and Azure AD auth
- **Parameter Format**: Instead of `env-config.txt` hardcoding, pass parameters to `azd provision`
- **Deployment Command**: `.\deploy.ps1` ‚Üí `azd provision`

---

## ‚öôÔ∏è Naming Constraints Enforced

- **Storage Account**: Lowercase, 3‚Äì24 chars, alphanumeric (special handling: `st{env}{token}` with normalized casing)
- **SQL Server**: Globally unique, letters/numbers/hyphens
- **App Services**: Allow hyphens; deterministic FQDN
- **All resources**: Length and character validation in Bicep to fail fast with clear errors

---

## üéØ Design Principles

1. **Declarative IaC**: Bicep handles all resource creation; scripts remain for testing/diagnostics
2. **No Secrets in Code**: Managed Identity and Azure AD auth eliminate stored passwords
3. **Reproducible Naming**: Deterministic tokens + optional overrides = predictable, isolated deployments
4. **Backwards Compatible**: Existing simulate/generate scripts work unchanged
5. **Cost-Optimized**: B1 App Service, Basic SQL, minimal storage for demo purposes

---

## üìû Troubleshooting

**Missing `env-config.txt`?**
```powershell
azd provision  # Re-runs and auto-generates env-config.txt via post-provision hook
```

**SQL firewall errors?**
```powershell
azd provision  # Re-runs and updates firewall rules
```

**Want to cleanup?**
```powershell
azd down  # Removes all azd-provisioned resources
```

---

## Summary

The migration is **complete and ready for testing**. The new azd-based infrastructure is:
- ‚úÖ Declarative and version-controllable
- ‚úÖ Secure (no embedded passwords, Managed Identity)
- ‚úÖ Reproducible (deterministic naming)
- ‚úÖ Scalable (parameterized, modular Bicep)
- ‚úÖ Backwards compatible (existing scripts still work)

Proceed to testing in a non-production Azure subscription. üöÄ
